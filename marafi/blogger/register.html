<!doctype html>
<html dir="rtl" lang="ar">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إنشاء حساب مدون — نادي أديب</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="auth.css" />
  </head>
  <body>
    <div class="auth-card" role="main">
      <header class="auth-header">
        <img alt="شعار نادي أديب" src="https://lh3.googleusercontent.com/d/195w-tUBF_VKwFOm3Sh06fmwnlYzIyw0e" />
        <div>
          <h1 class="auth-title">إنشاء حساب مدون</h1>
          <p class="auth-subtitle">سجّل بريدك وكلمة المرور لإنشاء حسابك والدخول إلى لوحة المدونين.</p>
        </div>
      </header>

      <div id="status" class="muted"></div>

      <form id="registerForm" class="auth-form">
        <label>
          الاسم الكامل
          <input id="name" name="name" type="text" autocomplete="name" required placeholder="الاسم كما سيظهر في المدونة" class="auth-input" />
        </label>
        <label>
          البريد الإلكتروني
          <input id="email" name="email" type="email" inputmode="email" autocomplete="email" required placeholder="name@example.com" class="auth-input" />
        </label>
        <label>
          كلمة المرور
          <input id="password" name="password" type="password" autocomplete="new-password" required placeholder="••••••••" minlength="6" class="auth-input" />
        </label>
        <div class="auth-actions">
          <button type="submit" class="btn-primary"><i class="fa-solid fa-user-plus"></i> إنشاء الحساب</button>
          <span id="msg" class="muted" aria-live="polite"></span>
        </div>
      </form>

      <div class="auth-footer">
        <a href="login.html"><i class="fa-solid fa-right-to-bracket"></i> لدي حساب</a>
        <a href="../blog/blog.html"><i class="fa-solid fa-anchor"></i> الرجوع للمدونة</a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script>
      (async function() {
        const sb = window.sbClient;
        const msg = document.getElementById('msg');
        const status = document.getElementById('status');
        const form = document.getElementById('registerForm');

        if (!sb) {
          status.className = 'alert error';
          status.textContent = 'Supabase غير مفعّل. تأكد من تحميل المكتبة وإعداد المفاتيح.';
          form.querySelector('button').disabled = true;
          return;
        }

        try {
          const { data: { session } } = await sb.auth.getSession();
          if (session) { location.replace('dashboard.html'); return; }
        } catch {}

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          msg.textContent = '';
          const name = document.getElementById('name').value.trim();
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;
          if (!name || !email || !password) { msg.textContent = 'الاسم والبريد وكلمة المرور مطلوبة'; return; }
          const btn = form.querySelector('button'); btn.disabled = true; btn.style.opacity = .7;
          try {
            const { data, error } = await sb.auth.signUp({
              email,
              password,
              options: { data: { role: 'blogger', name, display_name: name }, emailRedirectTo: new URL('dashboard.html', location.origin + location.pathname.replace(/[^/]+$/, '')).href }
            });
            if (error) throw error;
            // Depending on email confirmations setting, user may need to verify email first
            status.className = 'alert';
            if (data?.user?.confirmed_at || data?.session) {
              // logged in already
              location.replace('dashboard.html');
            } else {
              status.textContent = 'تم إنشاء الحساب. يرجى التحقق من بريدك لتفعيل الحساب إن لزم.';
            }
          } catch (err) {
            status.className = 'alert error';
            status.textContent = 'تعذر إنشاء الحساب: ' + (err?.message || 'تحقق من البيانات');
          } finally {
            btn.disabled = false; btn.style.opacity = 1;
          }
        });
      })();
    </script>
  </body>
</html>
