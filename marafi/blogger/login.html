<!doctype html>
<html dir="rtl" lang="ar">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تسجيل دخول المدونين — نادي أديب</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="auth.css" />
  </head>
  <body>
    <div class="auth-card" role="main">
      <header class="auth-header">
        <img alt="شعار نادي أديب" src="https://lh3.googleusercontent.com/d/195w-tUBF_VKwFOm3Sh06fmwnlYzIyw0e" />
        <div>
          <h1 class="auth-title">تسجيل دخول المدونين</h1>
          <p class="auth-subtitle">سجّل الدخول ببريدك وكلمة المرور للوصول إلى لوحة المدونين.</p>
        </div>
      </header>

      <div id="status" class="muted"></div>

      <form id="loginForm" class="auth-form">
        <label>
          البريد الإلكتروني
          <input id="email" name="email" type="email" inputmode="email" autocomplete="email" required placeholder="name@example.com" class="auth-input" />
        </label>
        <label>
          كلمة المرور
          <input id="password" name="password" type="password" autocomplete="current-password" required placeholder="••••••••" class="auth-input" />
        </label>
        <div class="auth-actions">
          <button type="submit" class="btn-primary"><i class="fa-solid fa-right-to-bracket"></i> تسجيل الدخول</button>
          <span id="msg" class="muted" aria-live="polite"></span>
        </div>
      </form>

      <div class="auth-footer">
        <a href="../blog/blog.html"><i class="fa-solid fa-anchor"></i> الرجوع للمدونة</a>
        <div style="display:flex; gap:12px">
          <a href="forgot.html"><i class="fa-solid fa-key"></i> نسيت كلمة المرور؟</a>
          <a href="register.html"><i class="fa-solid fa-user-plus"></i> إنشاء حساب مدون</a>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script>
      (async function() {
        const sb = window.sbClient;
        const msg = document.getElementById('msg');
        const status = document.getElementById('status');
        const form = document.getElementById('loginForm');

        if (!sb) {
          status.className = 'alert error';
          status.textContent = 'Supabase غير مفعّل. تأكد من تحميل المكتبة وإعداد المفاتيح.';
          form.querySelector('button').disabled = true;
          return;
        }

        try {
          const { data: { session } } = await sb.auth.getSession();
          if (session) { location.replace('dashboard.html'); return; }
        } catch {}

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          msg.textContent = '';
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;
          if (!email || !password) return;
          const btn = form.querySelector('button'); btn.disabled = true; btn.style.opacity = .7;
          try {
            const { data, error } = await sb.auth.signInWithPassword({ email, password });
            if (error) throw error;
            // Log login activity (best-effort)
            try {
              const { data: u } = await sb.auth.getUser();
              const user = u && u.user ? u.user : (data && data.user ? data.user : null);
              if (user) {
                await sb.from('activity_logs').insert({
                  user_id: user.id,
                  email: user.email,
                  type: 'login',
                });
              }
            } catch (_) {}
            const params = new URLSearchParams(location.search);
            const redirect = params.get('redirect') || 'dashboard.html';
            location.replace(redirect);
          } catch (err) {
            status.className = 'alert error';
            status.textContent = 'فشل تسجيل الدخول: ' + (err?.message || 'تحقق من البيانات');
          } finally {
            btn.disabled = false; btn.style.opacity = 1;
          }
        });
      })();
    </script>
  </body>
</html>
