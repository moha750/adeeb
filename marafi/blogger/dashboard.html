<!doctype html>
<html dir="rtl" lang="ar">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة المدونين — نادي أديب</title>
    <meta name="robots" content="noindex, nofollow" />
    <meta name="googlebot" content="noindex, nofollow" />
    <link rel="canonical" href="https://www.adeeb.club/marafi/blogger/dashboard.html" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" />
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="dashboard.css" />
  </head>
  <body>
    <div class="shell">
      <header class="top">
        <div class="right">
          <button id="toggleSidebar" class="btn btn-outline" title="القائمة"><i class="fa-solid fa-bars"></i></button>
        </div>
        <div class="left">
          <div id="bloggerUserBadge" class="user-badge" aria-live="polite"></div>
        </div>
      </header>
      
      <div class="admin-layout">
        <aside id="sidebar" class="admin-sidebar">
          <div class="admin-sidebar__brand">
            <span>لوحة المدونين</span>
            <button id="closeSidebarBtn" class="btn sidebar-close-btn" title="إغلاق" aria-label="إغلاق الشريط">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <nav class="admin-menu">
            <a href="#section-editor" class="admin-menu__item active"><i class="fa-solid fa-pen"></i> محرر تدوينة</a>
            <a href="#section-mine" class="admin-menu__item"><i class="fa-solid fa-list"></i> تدويناتي</a>
            <a href="#section-drafts" class="admin-menu__item"><i class="fa-regular fa-file-lines"></i> المسودات</a>
            <a href="#section-scheduled" class="admin-menu__item"><i class="fa-regular fa-calendar-days"></i> المجدولة</a>
            <a href="#section-manage" class="admin-menu__item"><i class="fa-solid fa-newspaper"></i> إدارة المقالات</a>
            <a href="#section-comments" class="admin-menu__item"><i class="fa-regular fa-comments"></i> إدارة التعليقات</a>
            <a href="#section-profile" class="admin-menu__item"><i class="fa-solid fa-user"></i> ملفي</a>
            <div class="admin-menu__footer">
              <button type="button" class="btn btn-outline" id="logoutBtnSidebar"><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</button>
              <a class="btn btn-primary" href="../blog/blog.html"><i class="fa-solid fa-globe"></i> عرض المدونة</a>
            </div>
          </nav>
        </aside>

        <main class="admin-main">
          <section id="section-editor" class="admin-section">
            <div class="section-head">
              <h2><i class="fa-solid fa-pen"></i> محرر تدوينة</h2>
            </div>
              <div class="card__body">
                <form id="postForm" class="form" autocomplete="off" style="display:grid;gap:10px">
                  <input type="hidden" id="postId" />
                  <label>العنوان
                    <input id="title" required placeholder="عنوان التدوينة" />
                    <small id="titleCounter" class="char-counter ok" aria-live="polite">عدد الحروف المسموح بها: 0/50</small>
                  </label>
                  <label>صورة الغلاف
                    <input id="image_file" type="file" accept="image/*" />
                    <input id="image_url" type="hidden" />
                    <small class="muted">اختر صورة ليتم رفعها تلقائيًا وحفظ رابطها.</small>
                    <div style="margin-top:8px">
                      <img id="image_preview" alt="معاينة الصورة" style="max-width:240px; display:none; border-radius:8px" />
                    </div>
                  </label>
                  <label>المقتطف
                    <textarea id="excerpt" placeholder="ملخص قصير"></textarea>
                    <small id="excerptCounter" class="char-counter ok" aria-live="polite">عدد الحروف المسموح بها: 0/70</small>
                  </label>
                  <label>التصنيفات
                    <input id="categories" placeholder="مثال: أدب, مبادرات, قصص" />
                    <small class="muted">افصل بين التصنيفات بفاصلة عربية أو إنجليزية.</small>
                  </label>
                  <div class="rich-editor-container">
                    <label>المحتوى</label>
                    <div class="editor-toolbar">
                      <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" data-command="bold" title="عريض (Ctrl+B)">
                          <i class="fa-solid fa-bold"></i>
                        </button>
                      </div>
                      <div class="toolbar-separator"></div>
                      <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" id="normalTextBtn" title="نص عادي">
                          نص
                        </button>
                        <button type="button" class="toolbar-btn" id="headingTextBtn" title="نص عنوان (أكبر + عريض)">
                          عنوان
                        </button>
                      </div>
                      <div class="toolbar-separator"></div>
                      <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" data-command="justifyRight" title="محاذاة يمين">
                          <i class="fa-solid fa-align-right"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="justifyCenter" title="توسيط">
                          <i class="fa-solid fa-align-center"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="justifyLeft" title="محاذاة يسار">
                          <i class="fa-solid fa-align-left"></i>
                        </button>
                      </div>
                      <div class="toolbar-separator"></div>
                      <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="قائمة مرقمة">
                          <i class="fa-solid fa-list-ol"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="قائمة نقطية">
                          <i class="fa-solid fa-list-ul"></i>
                        </button>
                      </div>
                      <div class="toolbar-separator"></div>
                      <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" data-command="createLink" title="إدراج رابط">
                          <i class="fa-solid fa-link"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="insertImage" title="إدراج صورة">
                          <i class="fa-regular fa-image"></i>
                        </button>
                      </div>
                      <div class="toolbar-separator"></div>
                      <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" data-command="undo" title="تراجع (Ctrl+Z)">
                          <i class="fa-solid fa-rotate-left"></i>
                        </button>
                        <button type="button" class="toolbar-btn" data-command="redo" title="إعادة (Ctrl+Y)">
                          <i class="fa-solid fa-rotate-right"></i>
                        </button>
                      </div>
                      
                    </div>
                    <div class="editor-wrapper">
                      <div id="richEditor" class="rich-text-editor" contenteditable="true" placeholder="ابدأ الكتابة هنا..."></div>
                      <input type="hidden" id="content" />
                      <input id="editor_image_file" type="file" accept="image/*" style="display:none" />
                      
                    </div>
                    <div class="editor-status-bar">
                      <span id="charCount">0 حرف</span>
                      <span class="status-separator">|</span>
                      <span id="spaceCount">0 مسافة</span>
                      <span class="status-separator">|</span>
                      <span id="wordCount">0 كلمة</span>
                      <span class="status-separator">|</span>
                      <span id="editorMode">مُحرر مرافئ</span>
                    </div>
                  </div>
                  <div style="display:grid; gap:6px">
                    <label>تاريخ ووقت النشر المجدول
                      <input id="schedule_at" type="datetime-local" />
                      <small class="muted">اتركه فارغًا إن كنت لا تريد الجدولة. سيُحفظ التوقيت بالمنطقة الزمنية لجهازك.</small>
                    </label>
                  </div>
                  <div style="display:flex; gap:8px; flex-wrap:wrap">
                    <button class="btn btn-outline" type="button" id="saveDraftBtn"><i class="fa-regular fa-floppy-disk"></i> مسودة</button>
                    <button class="btn btn-outline" type="button" id="scheduleBtn"><i class="fa-regular fa-calendar"></i> جدولة</button>
                    <button class="btn btn-primary" type="submit"><i class="fa-solid fa-save"></i> حفظ</button>
                    <button class="btn" type="button" id="resetBtn"><i class="fa-solid fa-eraser"></i> مسح</button>
                  </div>
                </form>
              </div>
          </section>

          <section id="section-mine" class="admin-section" hidden>
            <div class="section-head">
              <h2><i class="fa-solid fa-list"></i> تدويناتي</h2>
            </div>
            <div class="list" id="myPosts"></div>
          </section>

          <section id="section-drafts" class="admin-section" hidden>
            <div class="section-head">
              <h2><i class="fa-regular fa-file-lines"></i> المسودات</h2>
            </div>
            <div class="muted">تظهر هنا المسودات الخاصة بك فقط.</div>
            <div class="list" id="myDrafts"></div>
          </section>

          <section id="section-scheduled" class="admin-section" hidden>
            <div class="section-head">
              <h2><i class="fa-regular fa-calendar-days"></i> التدوينات المجدولة</h2>
            </div>
            <div class="muted">التدوينات التي تم تعيين تاريخ نشر لها وستظل مخفية حتى النشر.</div>
            <div class="list" id="myScheduled"></div>
          </section>

          <section id="section-manage" class="admin-section" hidden>
            <div class="section-head">
              <h2><i class="fa-solid fa-newspaper"></i> إدارة المقالات</h2>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
              <label>الحالة
                <select id="manageStatus">
                  <option value="all">الكل</option>
                  <option value="published">المنشورة</option>
                  <option value="scheduled">المجدولة</option>
                  <option value="draft">المسودات</option>
                </select>
              </label>
              <label style="display:inline-flex; align-items:center; gap:6px">
                <input id="manageAllToggle" type="checkbox" />
                <span>جميع المدونين</span>
              </label>
              <button id="manageRefreshBtn" type="button" class="btn btn-outline"><i class="fa-solid fa-rotate"></i> تحديث</button>
              <span id="manageMsg" class="muted" aria-live="polite"></span>
            </div>
            <div class="list" id="managePostsList"></div>
          </section>

          <section id="section-comments" class="admin-section" hidden>
            <div class="section-head">
              <h2><i class="fa-regular fa-comments"></i> إدارة التعليقات</h2>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
              <button id="refreshCommentsAdminBtn" type="button" class="btn btn-outline"><i class="fa-solid fa-rotate"></i> تحديث</button>
              <span id="commentsAdminMsg" class="muted" aria-live="polite"></span>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0 10px">
              <button id="selectAllCommentsBtn" type="button" class="btn btn-outline"><i class="fa-regular fa-square-check"></i> تحديد الكل</button>
              <button id="clearSelectedCommentsBtn" type="button" class="btn"><i class="fa-regular fa-square"></i> إلغاء التحديد</button>
              <button id="deleteSelectedCommentsBtn" type="button" class="btn btn-danger" disabled><i class="fa-solid fa-trash"></i> حذف المحدد</button>
              <span id="commentsSelectedMsg" class="muted" aria-live="polite"></span>
            </div>
            <div class="list" id="commentsAdminList"></div>
          </section>

          <section id="section-profile" class="admin-section" hidden>
            <div class="section-head">
              <h2><i class="fa-solid fa-user"></i> ملفي الشخصي</h2>
            </div>
            <div class="profile-section">
              <!-- بطاقة المعلومات الأساسية -->
              <div class="profile-card">
                <div class="profile-card__header">
                  <i class="fa-solid fa-id-card"></i>
                  <h3 class="profile-card__title">معلوماتي الأساسية</h3>
                </div>
                <div class="profile-avatar">
                  <div class="profile-avatar__preview" id="avatarPreview"></div>
                  <div class="profile-avatar__info">
                    <div id="profileUserName" style="font-weight: bold; font-size: 1.1rem; color: var(--main-blue);"></div>
                    <div class="profile-status">
                      <span class="profile-status__dot"></span>
                      <span>مدون في نادي أديب</span>
                    </div>
                  </div>
                </div>
                <form id="profileForm">
                  <label>البريد الإلكتروني
                    <input id="profileEmail" type="email" disabled />
                  </label>
                  <label>اسم العرض
                    <input id="display_name" placeholder="اسمك الظاهر للزوار" />
                    <small class="muted">سيظهر هذا الاسم في المدونة عند النشر</small>
                  </label>
                  <label>صورة الملف الشخصي
                    <input id="avatar_file" type="file" accept="image/*" />
                    <small class="muted">الصور المناسبة: JPG, PNG بحد أقصى 2MB</small>
                  </label>
                  <div class="profile-actions">
                    <button class="btn btn-primary" type="submit"><i class="fa-solid fa-save"></i> حفظ التغييرات</button>
                    <span id="profileMsg" class="muted" aria-live="polite"></span>
                  </div>
                </form>
              </div>

              <!-- بطاقة تغيير كلمة المرور -->
              <div class="profile-card">
                <div class="profile-card__header">
                  <i class="fa-solid fa-lock"></i>
                  <h3 class="profile-card__title">الأمان وكلمة المرور</h3>
                </div>
                <form id="changePasswordForm">
                  <label>كلمة المرور الحالية
                    <input id="current_password" type="password" autocomplete="current-password" placeholder="••••••••" required />
                  </label>
                  <label>كلمة المرور الجديدة
                    <input id="new_password" type="password" autocomplete="new-password" placeholder="••••••••" required />
                    <small class="muted">يجب أن تحتوي على 6 أحرف على الأقل</small>
                  </label>
                  <label>تأكيد كلمة المرور الجديدة
                    <input id="confirm_password" type="password" autocomplete="new-password" placeholder="••••••••" required />
                  </label>
                  <div class="profile-actions">
                    <button class="btn btn-primary" type="submit"><i class="fa-solid fa-key"></i> تغيير كلمة المرور</button>
                    <button class="btn btn-outline" type="button" id="forgotPwdBtn"><i class="fa-regular fa-envelope"></i> نسيت كلمة المرور؟</button>
                    <span id="passwordMsg" class="muted" aria-live="polite"></span>
                  </div>
                </form>
              </div>

              <!-- بطاقة تغيير البريد الإلكتروني -->
              <div class="profile-card">
                <div class="profile-card__header">
                  <i class="fa-regular fa-envelope"></i>
                  <h3 class="profile-card__title">البريد الإلكتروني</h3>
                </div>
                <form id="changeEmailForm">
                  <label>البريد الإلكتروني الحالي
                    <input id="current_email_display" type="email" disabled />
                  </label>
                  <label>البريد الإلكتروني الجديد
                    <input id="new_email" type="email" placeholder="name@example.com" autocomplete="email" required />
                  </label>
                  <label>كلمة المرور الحالية (للتأكيد)
                    <input id="current_password_email" type="password" autocomplete="current-password" placeholder="••••••••" required />
                  </label>
                  <div class="profile-actions">
                    <button class="btn btn-primary" type="submit"><i class="fa-regular fa-envelope"></i> تغيير البريد الإلكتروني</button>
                    <span id="emailMsg" class="muted" aria-live="polite"></span>
                  </div>
                </form>
              </div>

              <!-- بطاقة سجل النشاط -->
              <div class="profile-card" id="activitySection">
                <div class="profile-card__header">
                  <i class="fa-regular fa-clock"></i>
                  <h3 class="profile-card__title">سجل نشاطي</h3>
                </div>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
                  <button id="refreshActivityBtn" type="button" class="btn btn-outline"><i class="fa-solid fa-rotate"></i> تحديث</button>
                  <span id="activityMsg" class="muted" aria-live="polite"></span>
                </div>
                <ul id="activityList" class="list" style="list-style:none; padding:0; margin:0"></ul>
              </div>

              <!-- بطاقة حذف الحساب -->
              <div class="profile-card">
                <div class="profile-card__header">
                  <i class="fa-solid fa-user-xmark"></i>
                  <h3 class="profile-card__title">حذف الحساب</h3>
                </div>
                <form id="deleteAccountForm" style="display:grid; gap:10px; max-width:520px">
                  <div class="muted" style="color:#ff6b6b">تحذير: حذف الحساب نهائي وغير قابل للاسترجاع. سيتم حذف بياناتك وتسجيل خروجك فورًا.</div>
                  <label>أدخل كلمة المرور للتأكيد
                    <input id="delete_password" type="password" autocomplete="current-password" placeholder="••••••••" required />
                  </label>
                  <div class="profile-actions">
                    <button id="deleteAccountBtn" class="btn btn-danger" type="submit"><i class="fa-solid fa-user-xmark"></i> حذف الحساب نهائيًا</button>
                    <span id="deleteMsg" class="muted" aria-live="polite"></span>
                  </div>
                </form>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    

    <dialog id="imageCropDialog" class="admin-dialog">
      <form method="dialog" class="dialog-form" id="imageCropForm">
        <div class="dialog-header">
          <h3 class="dialog-title">قص الصورة</h3>
          <button type="button" class="dialog-close" aria-label="إغلاق" onclick="this.closest('dialog').close()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="dialog-body">
          <div id="cropToolbar" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
            <div style="flex:1"></div>
            <button type="button" class="btn btn-outline" id="cropZoomIn" title="تكبير"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
            <button type="button" class="btn btn-outline" id="cropZoomOut" title="تصغير"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
            <button type="button" class="btn btn-outline" id="cropRotateL" title="تدوير يسار"><i class="fa-solid fa-rotate-left"></i></button>
            <button type="button" class="btn btn-outline" id="cropRotateR" title="تدوير يمين"><i class="fa-solid fa-rotate-right"></i></button>
            <button type="button" class="btn btn-outline" id="cropFlipH" title="عكس أفقي"><i class="fa-solid fa-arrows-left-right"></i></button>
            <button type="button" class="btn btn-outline" id="cropFlipV" title="عكس عمودي"><i class="fa-solid fa-arrows-up-down"></i></button>
            <button type="button" class="btn" id="cropReset" title="إعادة الضبط"><i class="fa-solid fa-undo"></i> إعادة</button>
          </div>
          <div id="cropperArea">
            <img id="cropperImage" alt="معاينة القص" />
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <small class="field-help">اسحب وحدد الإطار ثم اضغط تأكيد للحفظ.</small>
            <small id="cropBusy" class="field-help" style="display:none;color:#0ea5e9">جارٍ المعالجة...</small>
          </div>
        </div>
        <menu class="dialog-actions">
          <button type="button" class="btn" id="cropCancelBtn">إلغاء</button>
          <button value="submit" class="btn btn-primary" id="cropConfirmBtn">تأكيد</button>
        </menu>
      </form>
    </dialog>

    <!-- Unsaved changes modal (save as draft) -->
    <div id="unsavedDraftModal" class="modal" hidden>
      <div class="modal__backdrop"></div>
      <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="unsavedDraftTitle">
        <h3 id="unsavedDraftTitle">لديك تغييرات غير محفوظة</h3>
        <p class="muted">هل تريد حفظ التغييرات كمسودة قبل المتابعة؟</p>
        <div class="actions" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
          <button id="unsavedSaveDraftBtn" class="btn btn-primary"><i class="fa-regular fa-floppy-disk"></i> حفظ كمسودة</button>
          <button id="unsavedDiscardBtn" class="btn btn-danger"><i class="fa-solid fa-trash"></i> تجاهل</button>
          <button id="unsavedCancelBtn" class="btn btn-outline">إلغاء</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
    <script src="../supabase-config.js"></script>
    <script src="dashboard.js"></script>
  </body>
</html>
