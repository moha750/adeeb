<!doctype html>
<html dir="rtl" lang="ar">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تعيين كلمة المرور — المدونين</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <link rel="stylesheet" href="/style.css" />
    <style>
      body { min-height: 100vh; display: grid; place-items: center; background: #0b0b0c; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial }
      .card { width: min(520px, 92vw); background: #121214; border: 1px solid #222; border-radius: 14px; padding: 28px; box-shadow: 0 10px 30px rgba(0,0,0,.35) }
      header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px }
      header img { width: 42px; height: 42px; border-radius: 8px; object-fit: cover }
      h1 { font-size: 1.15rem; margin: 0 }
      p { color: #bbb; margin: 6px 0 0; font-size: .95rem }
      form { display: grid; gap: 12px; margin-top: 14px }
      label { display: grid; gap: 6px; font-size: .95rem; color: #ddd }
      input[type=password] { background: #0f0f11; color: #fff; border: 1px solid #2a2a2e; border-radius: 10px; padding: 12px 14px }
      .actions { display: flex; gap: 10px; align-items: center }
      button.btn-primary { display: inline-flex; align-items: center; gap: 8px; background: #22c55e; color: #fff; border: none; border-radius: 10px; padding: 10px 14px; cursor: pointer }
      .muted { color: #9aa; font-size: .9rem }
      .alert { background:#0d1b0d; border:1px solid #1b3a1b; color:#b5f7b5; padding:10px 12px; border-radius:10px }
      .error { background:#2a1212; border-color:#612; color:#ffb0b0 }
      a { color: #9ecbff }
    </style>
  </head>
  <body>
    <div class="card" role="main">
      <header>
        <img alt="شعار نادي أديب" src="https://lh3.googleusercontent.com/d/195w-tUBF_VKwFOm3Sh06fmwnlYzIyw0e" />
        <div>
          <h1>تعيين كلمة المرور الجديدة</h1>
          <p>أدخل كلمة المرور الجديدة لحسابك.</p>
        </div>
      </header>

      <div id="status" class="muted"></div>

      <form id="resetForm">
        <label>
          كلمة المرور الجديدة
          <input id="password" name="password" type="password" autocomplete="new-password" required minlength="6" placeholder="••••••••" />
        </label>
        <label>
          تأكيد كلمة المرور
          <input id="password2" name="password2" type="password" autocomplete="new-password" required minlength="6" placeholder="••••••••" />
        </label>
        <div class="actions">
          <button type="submit" class="btn-primary"><i class="fa-solid fa-lock"></i> حفظ كلمة المرور</button>
          <span id="msg" class="muted" aria-live="polite"></span>
        </div>
      </form>

      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <a href="login.html"><i class="fa-solid fa-right-to-bracket"></i> العودة لتسجيل الدخول</a>
        <a href="../blog/blog.html"><i class="fa-solid fa-anchor"></i> المدونة</a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script>
      (async function() {
        const sb = window.sbClient;
        const status = document.getElementById('status');
        const form = document.getElementById('resetForm');
        if (!sb) {
          status.className = 'alert error';
          status.textContent = 'Supabase غير مفعّل.';
          form.querySelector('button').disabled = true;
          return;
        }

        // Ensure we have a recovery session (from email link)
        try {
          const { data: { session } } = await sb.auth.getSession();
          if (!session) {
            status.className = 'alert error';
            status.textContent = 'الرابط غير صالح أو انتهت صلاحيته. أعد طلب الاستعادة.';
          }
        } catch {}

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const p1 = document.getElementById('password').value;
          const p2 = document.getElementById('password2').value;
          if (!p1 || p1 !== p2) {
            status.className = 'alert error';
            status.textContent = 'تأكد من تطابق كلمات المرور.';
            return;
          }
          const btn = form.querySelector('button'); btn.disabled = true; btn.style.opacity = .7;
          try {
            const { error } = await sb.auth.updateUser({ password: p1 });
            if (error) throw error;
            status.className = 'alert';
            status.textContent = 'تم تحديث كلمة المرور. سيتم تحويلك للوحة المدونين...';
            setTimeout(() => { location.replace('dashboard.html'); }, 800);
          } catch (err) {
            status.className = 'alert error';
            status.textContent = 'تعذر التحديث: ' + (err?.message || 'حدث خطأ');
          } finally {
            btn.disabled = false; btn.style.opacity = 1;
          }
        });
      })();
    </script>
  </body>
</html>
