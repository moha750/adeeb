<!doctype html>
<html dir="rtl" lang="ar">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تسجيل عضوية نادي أديب</title>
    <meta name="robots" content="noindex, nofollow" />
    <meta name="googlebot" content="noindex, nofollow" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css" />
    <style>
      body { min-height:100vh; display:grid; place-items:center; background:linear-gradient(135deg, #f8f9fa 0%, #e6f0f9 100%); color:#274060; font-family: fl; align-content: center;}
      .card { width:min(760px, 96vw); background:#ffffff; border:1px solid rgba(61,143,214,0.15); border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(39,64,96,0.08), 0 4px 12px rgba(39,64,96,0.06); }
      .card.closed-state { background: transparent !important; border: none !important; box-shadow: none !important; padding: 0 !important; }
      header { display:flex; flex-direction:column; align-items:center; gap:12px; margin-bottom:10px; text-align:center; }
      header img { width:10rem; }
      h1 { font-size:1.45rem; margin:0; color:#274060; font-family: fb; }
      p.muted { color:#335c81; margin:6px 0 0; font-size:.95rem; }
      .steps { display:flex; align-items:center; gap:8px; margin:14px 0 18px; }
      .step { display:flex; flex-direction:column; align-items:center; gap:6px; color:#5b708d; }
      .step .dot { width:26px; height:26px; display:grid; place-items:center; border-radius:50%; background:#ffffff; border:1px solid rgba(61,143,214,0.35); color:#274060; font-size:.9rem; transition: background-color .2s ease, color .2s ease, border-color .2s ease; transform:none; }
      .step.active .dot { background:linear-gradient(135deg, #3d8fd6, #274060); border-color:transparent; color:#fff; }
      .step.done .dot { background:#16a34a; border-color:#16a34a; color:transparent; position:relative; }
      .step.done .dot::after { content:'\2713'; position:absolute; inset:0; display:grid; place-items:center; color:#fff; font-size:.95rem; }
      .step .label { font-size:.92rem; text-align:center; line-height:1.2; }
      .sep { flex:1; height:2px; background:linear-gradient(90deg, rgba(61,143,214,0.25), rgba(39,64,96,0.25)); border-radius:2px; }
      form { display:block; }
      .step-pane { display:none; }
      .step-pane.active { display:block; }
      .grid { display:grid; gap:12px; grid-template-columns:1fr; }
      @media (min-width:720px){ .grid.two { grid-template-columns:1fr 1fr; } }
      label { display:grid; gap:6px; font-size:.95rem; color:#274060; }
      input[type=text], input[type=tel], input[type=email], input[type=url], select, textarea { background:#ffffff; color:#274060; border:1px solid #e2e8f0; border-radius:10px; padding:12px 14px; }
      textarea { min-height:120px; resize:vertical; }
      .actions { display:flex; justify-content:center; align-items:center; gap:12px; margin-top:12px; }
      .actions .left { display:flex; gap:10px; align-items:center; }
      .btn { -webkit-appearance:none; appearance:none; display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 16px; border-radius:12px; font-family: fb; font-size:14px; line-height:1; text-decoration:none; cursor:pointer; border:1px solid transparent; color:#1a2a3a; background:#fff; transition: transform .15s ease, background-color .2s ease, color .2s ease, box-shadow .2s ease, border-color .2s ease; user-select:none; }
      .btn i { font-size:.95em; }
      .btn:disabled, .btn[aria-disabled="true"] { opacity:.6; cursor:not-allowed; pointer-events:none; }
      .btn:focus-visible { outline:none; box-shadow:0 0 0 4px rgba(61,143,214,0.18); }
      .btn-primary { color:#fff; background:linear-gradient(135deg, var(--accent-blue), var(--main-blue)); border-color: rgba(61,143,214,0.35); box-shadow:0 8px 18px rgba(61,143,214,0.25), inset 0 1px 0 rgba(255,255,255,0.25); transition: all 0.5s; }
      .btn-primary:hover { transform: translateY(-1px); box-shadow:0 10px 22px rgba(61,143,214,0.3), inset 0 1px 0 rgba(255,255,255,0.25); filter: brightness(1.02); }
      .btn-primary:active { transform: translateY(0); box-shadow:0 6px 14px rgba(61,143,214,0.24) inset; }
      .btn-outline { color: var(--main-blue); background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(249,251,255,0.98)); border-color: rgba(61,143,214,0.35); box-shadow: 0 1px 0 rgba(255,255,255,0.8) inset, 0 2px 10px rgba(39,64,96,0.06); transition: all 0.5s; }
      .btn-outline:hover { color:#fff; background: linear-gradient(135deg, var(--accent-blue), #5aa9e6); border-color: rgba(61,143,214,0.5); transform: translateY(-1px); box-shadow: 0 8px 18px rgba(61,143,214,0.2); }
      .btn-outline:active { transform: translateY(0); box-shadow: 0 5px 12px rgba(61,143,214,0.18) inset; }
      .alert { background:rgba(61,143,214,0.08); border:1px solid rgba(61,143,214,0.25); color:#274060; padding:10px 12px; border-radius:10px; display:none; }
      .error { background:#fee2e2; border-color:#fecaca; color:#991b1b; }
      a { color:#3d8fd6; }
      .success-wrap { text-align:center; padding:18px 10px; }
      .join-closed { display:none; position:relative; overflow:hidden; text-align:center; padding:26px 20px; margin: 0 0 16px; border-radius:16px; background: linear-gradient(180deg, #ffffff, #f8fbff); border:1px solid rgba(61,143,214,0.25); box-shadow: 0 12px 34px rgba(39,64,96,0.10), 0 4px 14px rgba(39,64,96,0.06); color:#274060; animation: jcIn .25s ease; }
      .join-closed::before { content:''; position:absolute; inset:0; background: radial-gradient(800px 200px at 110% -10%, rgba(61,143,214,0.10), transparent 60%), radial-gradient(200px 800px at -10% 110%, rgba(39,64,96,0.08), transparent 60%); pointer-events:none; }
      .join-closed::after { content:''; position:absolute; inset:0 auto auto 0; height:3px; width:100%; background: linear-gradient(90deg, var(--accent-blue), #5aa9e6); opacity:.9; border-top-left-radius:16px; border-top-right-radius:16px; }
      .jc-head { display:flex; flex-direction: column; gap:10px; align-items:center; justify-content:center; margin-top:6px; }
      .jc-icon { position:relative; display:grid; place-items:center; width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg, var(--accent-blue), var(--main-blue)); color:#fff; box-shadow:0 10px 22px rgba(61,143,214,0.25); animation: jcPop .35s ease; }
      .jc-icon::after { content:''; position:absolute; inset:-4px; border-radius:50%; border:2px solid rgba(255,255,255,0.35); }
      .jc-icon i { font-size:1.25rem; }
      .jc-title {
        font-family: fb;
        font-size:1.2rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: linear-gradient(180deg, rgba(61, 143, 214, 0.10), rgba(61, 143, 214, 0.06));
        border: 1px solid rgba(61, 143, 214, 0.28);
        color: #3d8fd6;
        box-shadow: 0 1px 0 rgba(255, 255, 255, 0.8) inset;
      }
      .jc-logo { display:grid; place-items:center; margin-bottom:1rem; }
      .jc-logo img { width:10rem;}
      .jc-desc { margin:12px 0 8px; color:#335c81; line-height:1.8; }
      .jc-next { display:none; margin:4px 0 16px; color:#274060; font-size:.95rem; }
      .jc-next small { color:#335c81; }
      .jc-actions { display:flex; align-items:center; justify-content:center; gap:12px; margin-top:4px; }
      .jc-actions .btn { min-width: 200px; }
      @keyframes jcIn { from { opacity:0; transform: translateY(-6px);} to { opacity:1; transform: translateY(0);} }
      @keyframes jcPop { from { transform: scale(.92);} to { transform: scale(1);} }
      @media (max-width:560px){ .jc-icon { width:52px; height:52px; } .jc-title { font-size:1.1rem; } .jc-actions .btn { min-width: 160px; } }
      @media (prefers-reduced-motion: reduce){ .join-closed, .jc-icon { animation:none !important; } }
      .field-error { display:none; align-items:center; gap:8px; margin: 20px 0px; padding:8px 10px; border-radius:10px; background: rgba(245,158,11,.08); border:1px solid rgba(245,158,11,.3); color:#92400e; max-height:0; opacity:0; overflow:hidden; transform: translateY(-4px); transition: max-height .25s ease, opacity .2s ease, transform .2s ease; }
      .field-error.show { display:flex; max-height: 120px; opacity: 1; transform: translateY(0); margin-top:6px; }
      .field-error i { color:#d97706; }
      .invalid { border-color:#f59e0b !important; box-shadow:0 0 0 3px rgba(245,158,11,.2); }
      /* Modern Adeeb field styling */
      input[type=text], input[type=tel], input[type=email], input[type=url], select, textarea {
        box-shadow: 0 1px 0 rgba(255,255,255,0.8) inset, 0 2px 10px rgba(39,64,96,0.06);
        transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease, transform .1s ease;
        background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(249,251,255,0.98));
        border-color: #e3eef9;
        margin-bottom: 2rem;
      }
      /* Remove bottom spacing when error is visible */
      label.has-error input[type=text],
      label.has-error input[type=tel],
      label.has-error input[type=email],
      label.has-error input[type=url],
      label.has-error select,
      label.has-error textarea { margin-bottom: 0 !important; }
      /* Also when element is marked invalid */
      input.invalid, select.invalid, textarea.invalid { margin-bottom: 0 !important; }
      input[type=text]::placeholder, input[type=tel]::placeholder, input[type=email]::placeholder, input[type=url]::placeholder, textarea::placeholder { color:#7c8aa3; }
      input[type=text]:hover, input[type=tel]:hover, input[type=email]:hover, input[type=url]:hover, select:hover, textarea:hover {
        background: linear-gradient(180deg, #ffffff, #f7fbff);
        border-color: rgba(61,143,214,0.28);
      }
      input[type=text]:focus-visible, input[type=tel]:focus-visible, input[type=email]:focus-visible, input[type=url]:focus-visible, select:focus-visible, textarea:focus-visible {
        outline: none;
        box-shadow: 0 0 0 4px rgba(61,143,214,0.18), 0 2px 10px rgba(39,64,96,0.06);
        border-color: rgba(61,143,214,0.35);
      }
      /* Valid state */
      input.valid, select.valid, textarea.valid { border-color:#10b981 !important; box-shadow:0 0 0 3px rgba(16,185,129,.2), 0 1px 0 rgba(255,255,255,0.8) inset; }
      .chips.valid { border-color:#10b981 !important; box-shadow:0 0 0 3px rgba(16,185,129,.2), 0 1px 0 rgba(255,255,255,0.8) inset; }
      /* Custom select arrow */
      select { appearance: none; -webkit-appearance:none; -moz-appearance:none; background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23274060' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'></polyline></svg>"); background-repeat:no-repeat; background-position: 12px center; padding-left:38px; }
      .chips { display:flex; flex-wrap:wrap; align-items:center; gap:6px; padding:8px 10px; min-height:46px; border:1px solid rgba(61,143,214,0.25); border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(249,251,255,0.98)); box-shadow: 0 1px 0 rgba(255,255,255,0.8) inset, 0 2px 10px rgba(39,64,96,0.06); }
      .chips:focus-within { box-shadow:0 0 0 4px rgba(61,143,214,0.18), 0 2px 10px rgba(39,64,96,0.06); border-color: rgba(61,143,214,0.35); }
      .chips.invalid { border-color:#f59e0b !important; box-shadow:0 0 0 3px rgba(245,158,11,.2); }
      .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:linear-gradient(180deg, rgba(61,143,214,0.10), rgba(61,143,214,0.06)); border:1px solid rgba(61,143,214,0.28); color:#274060; font-size:.9rem; animation: chip-in .16s ease; }
      .chip .remove { display:inline-grid; place-items:center; width:18px; height:18px; border-radius:50%; background:rgba(39,64,96,0.06); color:#274060; border:none; cursor:pointer; }
      .chip .remove:hover { background:rgba(39,64,96,0.12); }
      .chips input { flex:1 1 140px; min-width:120px; border:none; outline:none; background:transparent; padding:6px 8px; font-family: inherit; color:#274060; }
      .chips .add-btn { display:inline-flex; align-items:center; gap:6px; height:32px; padding:0 12px; border-radius:999px; border:1px solid rgba(61,143,214,0.35); background: linear-gradient(180deg, #ffffff, #f8fbff); color: var(--main-blue); cursor:pointer; box-shadow: 0 1px 0 rgba(255,255,255,0.8) inset, 0 2px 10px rgba(39,64,96,0.06); transition: transform .15s ease, box-shadow .2s ease, background-color .2s ease; }
      .chips .add-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(61,143,214,0.18); }
      .chips .add-btn:active { transform: translateY(0); box-shadow:none; }
      .chips .add-btn:disabled { opacity:.6; cursor:not-allowed; transform:none; box-shadow: none; }
      @keyframes chip-in { from { transform: scale(.96); opacity: .0; } to { transform: scale(1); opacity: 1; } }
      .step-hint { margin:10px 0 0; text-align:center; color:#274060; opacity:.9; font-size:.98rem; }
      /* Committee Info Modal */
      .committee-info-btn { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:8px; background:linear-gradient(180deg, #ffffff, #f8fbff); border:1px solid rgba(61,143,214,0.35); color:var(--main-blue); font-size:.85rem; cursor:pointer; transition: transform .15s ease, box-shadow .2s ease; }
      .committee-info-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(61,143,214,0.15); }
      .committee-info-btn i { font-size:.9em; }
      .modal-overlay { display:none; position:fixed; inset:0; background:rgba(39,64,96,0.5); backdrop-filter:blur(4px); z-index:9999; animation:fadeIn .2s ease; }
      .modal-overlay.active { display:flex; align-items:center; justify-content:center; padding:20px; }
      @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
      .modal-content { background:#ffffff; border-radius:16px; max-width:680px; width:100%; max-height:85vh; overflow:hidden; box-shadow:0 20px 60px rgba(39,64,96,0.3), 0 0 0 1px rgba(61,143,214,0.1); animation:slideUp .3s ease; }
      @keyframes slideUp { from { transform:translateY(20px); opacity:0; } to { transform:translateY(0); opacity:1; } }
      .modal-header { padding:20px 24px; border-bottom:1px solid rgba(61,143,214,0.1); background:linear-gradient(180deg, #f8fbff, #ffffff); }
      .modal-header h2 { margin:0; color:#274060; font-size:1.3rem; font-family:fb; display:flex; align-items:center; gap:10px; }
      .modal-header h2 i { color:#3d8fd6; font-size:.9em; }
      .modal-body { padding:20px 24px; overflow-y:auto; max-height:calc(85vh - 140px); }
      .committee-item { margin-bottom:20px; padding:16px; border-radius:12px; background:linear-gradient(180deg, rgba(61,143,214,0.03), rgba(61,143,214,0.01)); border:1px solid rgba(61,143,214,0.15); transition:transform .2s ease, box-shadow .2s ease; }
      .committee-item:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(61,143,214,0.12); }
      .committee-item h3 { margin:0 0 8px; color:#274060; font-size:1.1rem; font-family:fb; display:flex; align-items:center; gap:8px; }
      .committee-item h3 i { color:#3d8fd6; font-size:.85em; }
      .committee-item p { margin:0; color:#335c81; line-height:1.6; }
      .committee-item ol { margin:8px 0 0; padding-right:20px; color:#335c81; }
      .committee-item ol li { margin:4px 0; }
      .modal-footer { padding:16px 24px; border-top:1px solid rgba(61,143,214,0.1); background:linear-gradient(180deg, #ffffff, #f8fbff); display:flex; justify-content:center; }
      .modal-close-btn { padding:10px 24px; border-radius:10px; background:linear-gradient(135deg, var(--accent-blue), var(--main-blue)); color:#fff; border:none; font-family:fb; font-size:.95rem; cursor:pointer; transition:transform .15s ease, box-shadow .2s ease; }
      .modal-close-btn:hover { transform:translateY(-1px); box-shadow:0 8px 18px rgba(61,143,214,0.25); }
      .modal-close-btn:active { transform:translateY(0); }
      /* Membership closing countdown (Hero card above form) */
      .mc-wrap { display:none; width:min(760px, 96vw); margin: 0px auto 1rem; padding: 16px; border-radius: 16px; background: linear-gradient(135deg, var(--accent-blue, #3d8fd6), var(--main-blue, #274060)); color:#fff; border: 1px solid rgba(255,255,255,0.18); box-shadow: 0 16px 40px rgba(2,6,23,.18), 0 0 0 1px rgba(61,143,214,.10); }
      .mc-head { display:flex; align-items:center; justify-content:center; gap: 10px; color:#fff; font-family: fb; font-size:1.05rem; }
      .mc-head i { opacity:.9; }
      .mc-timer { display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:10px; }
      .mc-box { min-width:86px; display:grid; gap:6px; justify-items:center; background: rgba(255,255,255,0.14); border:1px solid rgba(255,255,255,0.28); padding:10px 12px; border-radius:12px; color:#fff; box-shadow: 0 1px 0 rgba(255,255,255,0.25) inset; }
      .mc-box span { font-family: fb; font-size: clamp(1.1rem, 3.5vw, 1.6rem); letter-spacing:.5px; }
      .mc-box small { font-family: fr; opacity:.9; }
      @media (max-width:560px){ .mc-box { min-width:70px; padding:8px 10px; } }
    </style>
  </head>
  <body>
    <div id="membershipCountdown" class="mc-wrap" aria-live="polite">
      <div class="mc-head">
        <div class="mc-label"><i class="fa-regular fa-hourglass-half"></i> يغلق التسجيل بعد</div>
      </div>
      <div class="mc-timer">
        <div class="mc-box"><span id="mcDays">--</span><small>يوم</small></div>
        <div class="mc-box"><span id="mcHours">--</span><small>ساعة</small></div>
        <div class="mc-box"><span id="mcMinutes">--</span><small>دقيقة</small></div>
        <div class="mc-box"><span id="mcSeconds">--</span><small>ثانية</small></div>
      </div>
    </div>
    <div class="card" role="main">
      <header>
        <img alt="شعار نادي أديب" src="https://lh3.googleusercontent.com/d/195w-tUBF_VKwFOm3Sh06fmwnlYzIyw0e" />
        <div>
          <h1>تسجيل عضوية</h1>
        </div>
      </header>
      <div class="steps" id="stepsBar" aria-hidden="false">
        <div class="step active" data-step="0"><div class="dot">1</div><div class="label">البيانات الأساسية</div></div>
        <div class="sep"></div>
        <div class="step" data-step="1"><div class="dot">2</div><div class="label">التواصل والجامعة</div></div>
        <div class="sep"></div>
        <div class="step" data-step="2"><div class="dot">3</div><div class="label">مهاراتك واهتماماتك</div></div>
        <div class="sep"></div>
        <div class="step" data-step="3"><div class="dot">4</div><div class="label">السوشيال ونبذة</div></div>
      </div>
      <p id="stepHint" class="step-hint">المحطة الأولى: عرفنا عن أسمك يا نعم المعرفة</p>
      <div id="joinClosedCard" class="join-closed" role="status" aria-live="polite">
        <div class="jc-logo"><img alt="شعار نادي أديب" src="https://lh3.googleusercontent.com/d/195w-tUBF_VKwFOm3Sh06fmwnlYzIyw0e" /></div>
        <div class="jc-head">
          <div class="jc-icon"><i class="fa-solid fa-lock"></i></div>
          <div class="jc-title">تم إغلاق باب التسجيل</div>
        </div>
        <div class="jc-desc">نعتذر، باب التسجيل مغلق حاليًا. تابعنا لمعرفة موعد الفتح القادم.</div>
        <div id="jcNext" class="jc-next" aria-live="polite"></div>
        <div class="jc-actions">
          <a class="btn btn-primary" href="index.html"><i class="fa-solid fa-arrow-right"></i><span>الرجوع لموقع أدِيب</span></a>
        </div>
      </div>

      <div id="status" class="alert" aria-live="polite"></div>

      <form id="membershipForm" novalidate>
        <section class="step-pane active" data-step="0">
          <div class="grid">
            <label>
              الأسم الثلاثي✍🏻
              <input id="fullName" name="fullName" type="text" required placeholder="أكتب الأسم هُنا" />
              <div id="fullNameError" class="field-error" role="alert" aria-live="polite"><i class="fa-solid fa-triangle-exclamation"></i><div><strong>أدخل أسمك الثلاثي</strong><div class="muted">الاسم الأول، اسم الأب، اسم العائلة</div></div></div>
            </label>
          </div>
        </section>

        <section class="step-pane" data-step="1">
          <div class="grid">
            <label>
              رقم الجوال📱
              <input id="phone" name="phone" type="tel" required placeholder="05XXXXXXXX" inputmode="numeric" autocomplete="tel" pattern="^05[0-9]{8}$" maxlength="10" />
              <div id="phoneError" class="field-error" role="alert" aria-live="polite"><i class="fa-solid fa-triangle-exclamation"></i><div><strong>أدخل رقم جوال صحيح</strong><div class="muted">10 أرقام تبدأ بـ 05 (مثال: 05XXXXXXXX)</div></div></div>
            </label>
          </div>
          <div class="grid">
            <label>
              البريد الإلكتروني📧
              <input id="email" name="email" type="email" required placeholder="name@example.com" />
              <div id="emailError" class="field-error" role="alert" aria-live="polite"><i class="fa-solid fa-triangle-exclamation"></i><div><strong>أدخل بريدًا إلكترونيًا صالحًا</strong><div class="muted">مثال: name@example.com</div></div></div>
            </label>
          </div>
          <div class="grid">
            <label>
              الدرجة العلمية📝
              <select id="degree" name="degree" required>
                <option value="">اختر الدرجة العلمية</option>
                <option>ثانوي</option>
                <option>موظف</option>
                <option>دبلوم</option>
                <option>بكالوريوس</option>
                <option>ماجستير</option>
                <option>دكتوراه</option>
              </select>
            </label>
          </div>
          <div class="grid two" id="collegeMajorRow">
            <label>
              الكلية🏫
              <input id="college" name="college" type="text" placeholder="أسم الكلية" required />
            </label>
            <label>
              التخصص📚
              <input id="major" name="major" type="text" placeholder="أسم التخصص" required />
            </label>
          </div>
        </section>

        <section class="step-pane" data-step="2">
          <div class="grid">
            <label id="skillsLabel">
              المهارات🔑
              <input id="skills" name="skills" type="hidden" required />
              <div id="skillsChips" class="chips" role="group" aria-labelledby="skillsLabel">
                <input id="skillsInputUI" type="text" placeholder="مثال: كتابة، تصوير، تصميم، برمجة" />
                <button type="button" id="addSkillBtn" class="add-btn" aria-label="إضافة مهارة"><i class="fa-solid fa-plus"></i><span>إضافة</span></button>
              </div>
            </label>
            <label>
              اللجنة المرغوب بها👤
              <button type="button" class="committee-info-btn" id="committeeInfoBtn">
                <i class="fa-solid fa-info-circle"></i>
                <span>اضغط للتعرف على لجان أدِيب</span>
              </button>
              <select id="preferredCommittee" name="preferredCommittee" required>
                <option value="">اختر اللجنة</option>
                <option>لجنة التأليف</option>
                <option>لجنة الرواة</option>
                <option>لجنة السفراء</option>
                <option>لجنة الفعاليات</option>
                <option>لجنة الإنتاج</option>
                <option>لجنة التصميم</option>
              </select>
            </label>
            <label>
              شاركنا رابط من أعمالك إنّ وجد🔗
              <input id="portfolioUrl" name="portfolioUrl" type="url" placeholder="https://example.com/portfolio" />
            </label>
          </div>
        </section>

        <section class="step-pane" data-step="3">
          <div class="grid">
            <label>
              تويتر🔗
              <input id="twitter" name="twitter" type="url" placeholder="https://twitter.com/username" />
            </label>
            <label>
              إنستغرام🔗
              <input id="instagram" name="instagram" type="url" placeholder="https://instagram.com/username" />
            </label>
            <label>
              تيك توك🔗
              <input id="linkedin" name="linkedin" type="url" placeholder="https://www.tiktok.com/in/username" />
            </label>
          </div>
          <div class="grid" style="margin-top:12px">
            <label>
              حدّثنا عن نفسك وطموحاتك التي تريد تحقيقها مع أدِيب🪶
              <textarea id="about" name="about" required placeholder="هذه مساحتك الحُرّه، كُلها لك"></textarea>
            </label>
          </div>
        </section>

        <div class="actions">
          <div class="left">
            <button type="button" class="btn btn-outline" id="prevBtn"><i class="fa-solid fa-arrow-right"></i> السابق</button>
            <button type="button" class="btn btn-primary" id="nextBtn">التالي <i class="fa-solid fa-arrow-left"></i></button>
          </div>
          <button type="submit" class="btn btn-primary" id="submitBtn" style="display:none"><i class="fa-solid fa-paper-plane"></i> إكمال طلب التسجيل</button>
        </div>
      </form>
    </div>

    <!-- Committee Info Modal -->
    <div class="modal-overlay" id="committeeModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fa-solid fa-users"></i> لجان نادي أدِيب</h2>
        </div>
        <div class="modal-body">
          <div class="committee-item">
            <h3><i class="fa-solid fa-pen-fancy"></i> لجنة التأليف</h3>
            <p>تتولى لجنة التأليف إعداد المحتوى الكتابي وصياغة أفكار الأركان والمشاركات بأسلوب يعكس هوية النادي ورسائله، لتكون الكلمة وسيلة للتأثير والإبداع.</p>
          </div>
          <div class="committee-item">
            <h3><i class="fa-solid fa-microphone"></i> لجنة الرواة</h3>
            <p>تمثل لجنة الرواة الواجهة الإعلامية للنادي، حيث تنقل صوته في الفعاليات والأنشطة، متحدثةً عن جوهر المشاركة ومعبّرةً عن روح وحدته.</p>
          </div>
          <div class="committee-item">
            <h3><i class="fa-solid fa-calendar-days"></i> لجنة الفعاليات</h3>
            <p>تُعنى لجنة الفعاليات بالتخطيط والتنظيم الميداني، وتشمل مهامها:</p>
            <ol>
              <li>إعداد جدول المشاركات في الأحداث المستقبلية.</li>
              <li>تنسيق وتصميم ديكور الأركان.</li>
              <li>تنظيم حركة الزوار وإدارة الازدحام بما يضمن انسيابية التجربة.</li>
            </ol>
          </div>
          <div class="committee-item">
            <h3><i class="fa-solid fa-video"></i> لجنة الإنتاج</h3>
            <p>تختص لجنة الإنتاج بتصوير وتوثيق أنشطة وفعاليات النادي، من خلال التقاط الصور والمقاطع المرئية، وإنتاجها بمونتاجٍ يعكس جمالية المشاركة وأثرها.</p>
          </div>
          <div class="committee-item">
            <h3><i class="fa-solid fa-handshake"></i> لجنة السفراء</h3>
            <p>تُعد لجنة السفراء حلقة الوصل بين النادي والرعاة والجهات الداعمة، وتُسهم في تعزيز العلاقات العامة وبناء صورة إيجابية للنادي في المجتمع.</p>
          </div>
          <div class="committee-item">
            <h3><i class="fa-solid fa-palette"></i> لجنة التصميم</h3>
            <p>تتولى لجنة التصميم تنفيذ الهوية البصرية للنادي، من خلال تصميم المنشورات والمواد الإعلانية الخاصة بالأنشطة والمشاركات، بما يعكس التميز والإبداع.</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="modal-close-btn" id="closeModalBtn">إغلاق</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
      function adeebUuid(){ try { return crypto.randomUUID(); } catch { return 'v-' + Math.random().toString(36).slice(2) + Date.now().toString(36); } }
      function getVisitorId(){ try { const k='adeeb_visitor_id'; let id=localStorage.getItem(k); if(!id){ id=adeebUuid(); localStorage.setItem(k,id); localStorage.setItem('adeeb_first_seen', new Date().toISOString()); } return id; } catch { return adeebUuid(); } }
      function getSessionId(){ try { const k='adeeb_session_id'; let sid=sessionStorage.getItem(k); if(!sid){ sid=adeebUuid(); sessionStorage.setItem(k,sid); } return sid; } catch { return adeebUuid(); } }

      (function(){
        const form = document.getElementById('membershipForm');
        const panes = Array.from(document.querySelectorAll('.step-pane'));
        const steps = Array.from(document.querySelectorAll('.steps .step'));
        const stepHint = document.getElementById('stepHint');
        const stepsBarEl = document.getElementById('stepsBar');
        const joinClosedCard = document.getElementById('joinClosedCard');
        const pageCard = document.querySelector('.card[role="main"]');
        const headerEl = pageCard ? pageCard.querySelector('header') : document.querySelector('.card > header');
        const jcNext = document.getElementById('jcNext');
        const status = document.getElementById('status');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const fullNameInput = document.getElementById('fullName');
        const phoneInput = document.getElementById('phone');
        const emailInput = document.getElementById('email');
        const fullNameError = document.getElementById('fullNameError');
        const phoneError = document.getElementById('phoneError');
        const emailError = document.getElementById('emailError');
        const degreeInput = document.getElementById('degree');
        const collegeMajorRow = document.getElementById('collegeMajorRow');
        const collegeInput = document.getElementById('college');
        const majorInput = document.getElementById('major');
        const skillsInput = document.getElementById('skills');
        const preferredCommitteeInput = document.getElementById('preferredCommittee');
        const skillsChips = document.getElementById('skillsChips');
        const skillsUI = document.getElementById('skillsInputUI');
        const addSkillBtn = document.getElementById('addSkillBtn');
        let skillsTags = [];
        let cur = 0;
        const touched = new Set();
        let skillsTouched = false;

        // Membership closing countdown
        const mcWrap = document.getElementById('membershipCountdown');
        const mcDays = document.getElementById('mcDays');
        const mcHours = document.getElementById('mcHours');
        const mcMinutes = document.getElementById('mcMinutes');
        const mcSeconds = document.getElementById('mcSeconds');
        let mcInterval = null;
        function publicSettingsGet(){ try { const raw=localStorage.getItem('adeeb_settings'); const obj= raw? JSON.parse(raw): {}; return (obj && typeof obj==='object' && !Array.isArray(obj))? obj : {}; } catch { return {}; } }
        function publicSettingsSet(obj){ try { localStorage.setItem('adeeb_settings', JSON.stringify(obj||{})); } catch {} }
        function isJoinOpenEffective(s){
          try {
            const sched = !!s.join_schedule_enabled;
            const openIso = s.join_schedule_open_at || null;
            const closeIso = s.join_schedule_close_at || null;
            if (sched && (openIso || closeIso)) {
              const now = Date.now();
              const openTs = openIso ? Date.parse(openIso) : null;
              const closeTs = closeIso ? Date.parse(closeIso) : null;
              if (openTs && closeTs) return now >= openTs && now < closeTs;
              if (openTs && !closeTs) return now >= openTs;
              if (!openTs && closeTs) return now < closeTs;
            }
            return s.join_open !== false;
          } catch { return s && s.join_open !== false; }
        }
        async function syncSettingsFromRemote(){
          const sb = window.sbClient;
          if(!sb) return;
          try {
            const { data, error } = await sb
              .from('membership_settings')
              .select('id, join_open, join_membership_countdown, join_schedule_enabled, join_schedule_mode, join_schedule_open_at, join_schedule_close_at, updated_at')
              .eq('id','default')
              .maybeSingle();
            if(error) throw error;
            if(data && typeof data==='object'){
              const cur = publicSettingsGet();
              publicSettingsSet({
                ...cur,
                join_open: data.join_open !== false,
                join_membership_countdown: !!data.join_membership_countdown,
                join_schedule_enabled: !!data.join_schedule_enabled,
                join_schedule_mode: data.join_schedule_mode || cur.join_schedule_mode,
                join_schedule_open_at: data.join_schedule_open_at || cur.join_schedule_open_at,
                join_schedule_close_at: data.join_schedule_close_at || cur.join_schedule_close_at,
              });
            }
          } catch{}
        }
        function computeCloseTarget(s){
          try{
            if(!s.join_schedule_enabled) return null;
            const mode = s.join_schedule_mode || 'range';
            const closeIso = s.join_schedule_close_at || null;
            if(!closeIso) return null;
            const closeTs = Date.parse(closeIso);
            if(Number.isNaN(closeTs)) return null;
            const now = Date.now();
            // Show countdown only while registration is effectively open and close is in the future
            if(!isJoinOpenEffective(s)) return null;
            if(now >= closeTs) return null;
            if(mode === 'range' || mode === 'close_only') return closeTs;
            return null;
          } catch { return null; }
        }
        function hasJoinConfig(s){ try { return !!(s && ('join_open' in s || 'join_schedule_enabled' in s || 'join_schedule_open_at' in s || 'join_schedule_close_at' in s)); } catch { return false; } }
        function enforceJoinAccess(){
          try{
            const s = publicSettingsGet();
            const isOpen = isJoinOpenEffective(s);
            if (joinClosedCard) joinClosedCard.style.display = isOpen ? 'none' : 'block';
            if (pageCard) pageCard.classList.toggle('closed-state', !isOpen);
            if (headerEl) headerEl.style.display = isOpen ? '' : 'none';
            if (stepsBarEl) stepsBarEl.style.display = isOpen ? '' : 'none';
            if (stepHint) stepHint.style.display = isOpen ? '' : 'none';
            if (form) form.style.display = isOpen ? '' : 'none';
            if (!isOpen) {
              if (jcNext) {
                let msg = '';
                try {
                  if (s && s.join_schedule_enabled) {
                    const now = Date.now();
                    const o = s.join_schedule_open_at ? Date.parse(s.join_schedule_open_at) : NaN;
                    const c = s.join_schedule_close_at ? Date.parse(s.join_schedule_close_at) : NaN;
                    const opts = { dateStyle: 'long', timeStyle: 'short' };
                    if (!Number.isNaN(o) && now < o) {
                      msg = `سيُفتح التسجيل ${new Date(o).toLocaleString('ar', opts)}`;
                    } else if (!Number.isNaN(c)) {
                      msg = `أُغلق التسجيل ${new Date(c).toLocaleString('ar', opts)}`;
                    }
                  }
                } catch {}
                jcNext.textContent = msg;
                jcNext.style.display = msg ? 'block' : 'none';
              }
            } else {
              if (jcNext) jcNext.style.display = 'none';
            }
            const btns = [prevBtn, nextBtn, submitBtn];
            btns.forEach(b => { if(!b) return; if(isOpen){ b.disabled=false; b.removeAttribute('aria-disabled'); } else { b.disabled=true; b.setAttribute('aria-disabled','true'); } });
          } catch {}
        }
        function startMembershipCountdown(){
          const s = publicSettingsGet();
          const show = !!s.join_membership_countdown;
          const target = computeCloseTarget(s);
          if(!mcWrap) return;
          if(!show || !target){
            mcWrap.style.display = 'none';
            if(mcInterval){ try{ clearInterval(mcInterval); }catch{} mcInterval=null; }
            return;
          }
          mcWrap.style.display = 'block';
          function tick(){
            const now = Date.now();
            let diff = Math.max(0, Math.floor((target - now)/1000));
            if(diff <= 0){ mcWrap.style.display='none'; if(mcInterval){ clearInterval(mcInterval); mcInterval=null; } return; }
            const d = Math.floor(diff / 86400); diff -= d*86400;
            const h = Math.floor(diff / 3600); diff -= h*3600;
            const m = Math.floor(diff / 60); diff -= m*60;
            const s2= diff;
            if(mcDays) mcDays.textContent = String(d).padStart(2,'0');
            if(mcHours) mcHours.textContent = String(h).padStart(2,'0');
            if(mcMinutes) mcMinutes.textContent = String(m).padStart(2,'0');
            if(mcSeconds) mcSeconds.textContent = String(s2).padStart(2,'0');
          }
          if(mcInterval){ clearInterval(mcInterval); mcInterval=null; }
          tick();
          mcInterval = setInterval(tick, 1000);
        }
        // Init: sync remote (if available), then start countdown, and refresh periodically
        enforceJoinAccess();
        syncSettingsFromRemote().then(()=>{ enforceJoinAccess(); startMembershipCountdown(); }).catch(()=>{ enforceJoinAccess(); startMembershipCountdown(); });
        setInterval(()=>{ try { startMembershipCountdown(); } catch {} }, 60000);

        // Realtime: apply changes instantly when admin updates settings
        let mcRtChannel = null;
        function ensureMembershipRealtime(){
          try{
            const sb = window.sbClient;
            if(!sb || mcRtChannel) return;
            mcRtChannel = sb.channel('public:membership_settings');
            mcRtChannel
              .on('postgres_changes', { event: '*', schema: 'public', table: 'membership_settings', filter: 'id=eq.default' }, (payload)=>{
                try{
                  const data = (payload && (payload.new || payload.old)) || {};
                  const cur = publicSettingsGet();
                  publicSettingsSet({
                    ...cur,
                    join_open: data.join_open !== false,
                    join_membership_countdown: typeof data.join_membership_countdown === 'boolean' ? data.join_membership_countdown : cur.join_membership_countdown,
                    join_control_type: data.join_control_type || cur.join_control_type,
                    join_schedule_enabled: !!data.join_schedule_enabled,
                    join_schedule_mode: data.join_schedule_mode || cur.join_schedule_mode,
                    join_schedule_open_at: data.join_schedule_open_at || cur.join_schedule_open_at,
                    join_schedule_close_at: data.join_schedule_close_at || cur.join_schedule_close_at,
                  });
                  enforceJoinAccess(); startMembershipCountdown();
                } catch{}
              })
              .subscribe();
          } catch{}
        }
        ensureMembershipRealtime();

        function ensureErrorEl(el){
          if(!el) return null;
          if(el.id === 'fullName') return fullNameError;
          if(el.id === 'phone') return phoneError;
          if(el.id === 'email') return emailError;
          const label = el.closest('label');
          if(!label) return null;
          let err = label.querySelector('.field-error[data-auto="1"]');
          if(!err){
            err = document.createElement('div');
            err.className = 'field-error';
            err.setAttribute('role','alert');
            err.setAttribute('aria-live','polite');
            err.setAttribute('data-auto','1');
            err.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i><div><strong></strong><div class="muted"></div></div>';
            label.appendChild(err);
          }
          return err;
        }
        function showErr(el, title, sub){
          const err = ensureErrorEl(el);
          if(err){
            const t = err.querySelector('strong'); if(t) t.textContent = title || 'هذا الحقل مطلوب';
            const s = err.querySelector('.muted'); if(s) s.textContent = sub || 'رجاءً املأ هذا الحقل';
            err.classList.add('show');
          }
          el?.classList.add('invalid');
          el?.setAttribute('aria-invalid','true');
          el?.classList.remove('valid');
          if(el === skillsInput && skillsChips) skillsChips.classList.add('invalid');
          if(el === skillsInput && skillsChips) skillsChips.classList.remove('valid');
          const lbl = el?.closest('label');
          if(lbl) lbl.classList.add('has-error');
        }
        function hideErr(el){
          const err = ensureErrorEl(el);
          if(err) err.classList.remove('show');
          el?.classList.remove('invalid');
          el?.removeAttribute('aria-invalid');
          if(el === skillsInput && skillsChips) skillsChips.classList.remove('invalid');
          const lbl = el?.closest('label');
          if(lbl) lbl.classList.remove('has-error');
        }

        function getDisplayName(){ const v = (fullNameInput && fullNameInput.value ? fullNameInput.value.trim() : ''); return v ? v.split(/\s+/)[0] : ''; }
        function updateStepHint(){
          if(!stepHint) return;
          const name = getDisplayName();
          let msg = '';
          if(cur === 0){ msg = 'عرفنا على أسمك يا نعمّ المعرفة🤝🏻'; }
          else if(cur === 1){ msg = name ? `أهلاً أهلاً ${name}, كيف مُمكن نتواصل معك🤔` : 'أهلاً أهلاً! عرفنا كيف نتواصل معك؟'; }
          else if(cur === 2){ msg = name ? `متحمسين نتعرف على مهاراتك يا ${name} 🤩` : 'متحمسين نعرف مهاراتك'; }
          else { msg = name ? `خِتامًا، هذه مساحتك يا ${name} 🪶` : 'خِتامًا، هذه مساحتك 🪶'; }
          stepHint.textContent = msg;
        }

        function showStep(i){
          cur = Math.max(0, Math.min(panes.length-1, i));
          panes.forEach((p,idx)=>{ p.classList.toggle('active', idx===cur); });
          steps.forEach((s,idx)=>{ s.classList.toggle('active', idx===cur); s.classList.toggle('done', idx<cur); });
          prevBtn.style.display = cur===0 ? 'none' : '';
          nextBtn.style.display = cur===panes.length-1 ? 'none' : '';
          submitBtn.style.display = cur===panes.length-1 ? '' : 'none';
          updateStepHint();
        }
        function validateStep(){
          const pane = panes[cur];
          let firstInvalid = null;
          const required = Array.from(pane.querySelectorAll('[required]'));
          for(const el of required){
            if(el === fullNameInput){
              const parts = (fullNameInput.value||'').trim().split(/\s+/).filter(Boolean);
              if(parts.length < 3){
                showErr(fullNameInput, 'أدخل اسمك الثلاثي', 'الاسم الأول، اسم الأب، اسم العائلة');
                if(!firstInvalid) firstInvalid = fullNameInput;
              } else { hideErr(fullNameInput); }
              fullNameInput.classList.toggle('valid', parts.length >= 3);
              continue;
            }
            if(cur === 1 && el === phoneInput){
              const raw = (phoneInput.value||'').trim();
              const digits = raw.replace(/\D/g,'');
              const ok = /^05\d{8}$/.test(digits);
              if(!ok){ showErr(phoneInput, 'أدخل رقم جوال صحيح', '10 أرقام تبدأ بـ 05 (مثال: 05XXXXXXXX)'); if(!firstInvalid) firstInvalid = phoneInput; } else { hideErr(phoneInput); }
              phoneInput.classList.toggle('valid', ok);
              continue;
            }
            if(cur === 1 && el === emailInput){
              const val = (emailInput.value||'').trim();
              const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
              if(!ok){ showErr(emailInput, 'أدخل بريدًا إلكترونيًا صالحًا', 'مثال: name@example.com'); if(!firstInvalid) firstInvalid = emailInput; } else { hideErr(emailInput); }
              emailInput.classList.toggle('valid', ok);
              continue;
            }
            if(el === degreeInput){
              const ok = !!(degreeInput.value||'').trim();
              if(!ok){ showErr(degreeInput, 'اختر الدرجة', 'يرجى اختيار الدرجة العلمية'); if(!firstInvalid) firstInvalid = degreeInput; } else { hideErr(degreeInput); }
              degreeInput.classList.toggle('valid', ok);
              continue;
            }
            const val = (el.value||'').trim();
            if(!val){
              let title = 'هذا الحقل مطلوب', sub = 'رجاءً املأ هذا الحقل';
              if(el === skillsInput) { title = 'أدخل مهاراتك'; sub = 'اذكر أبرز مهاراتك باختصار'; }
              if(el === preferredCommitteeInput) { title = 'حدد اللجنة المرغوب بها'; sub = 'اختر اللجنة التي ترغب بالانضمام إليها'; }
              if(el === collegeInput) { title = 'أدخل اسم الكلية'; sub = 'مثل: كلية الآداب'; }
              if(el === majorInput) { title = 'أدخل اسم التخصص'; sub = 'مثل: اللغة العربية'; }
              showErr(el, title, sub);
              if(!firstInvalid) firstInvalid = el;
            } else {
              hideErr(el);
              el.classList.toggle('valid', true);
            }
          }
          if(firstInvalid){ if(firstInvalid===skillsInput && skillsUI){ skillsUI.focus(); } else { firstInvalid.focus(); } return false; }
          return true;
        }

        // Show on blur only; hide on input after touched
        if(fullNameInput){
          fullNameInput.addEventListener('input', ()=>{
            if(!touched.has('fullName')) { updateStepHint(); return; }
            const parts = (fullNameInput.value||'').trim().split(/\s+/).filter(Boolean);
            if(parts.length >= 3){ hideErr(fullNameInput); }
            updateStepHint();
          });
          fullNameInput.addEventListener('blur', ()=>{
            touched.add('fullName');
            const parts = (fullNameInput.value||'').trim().split(/\s+/).filter(Boolean);
            if(parts.length >= 3){ hideErr(fullNameInput); }
            else { showErr(fullNameInput, 'أدخل اسمك الثلاثي', 'الاسم الأول، اسم الأب، اسم العائلة'); }
            updateStepHint();
          });
        }
        if(phoneInput){
          phoneInput.addEventListener('input', ()=>{
            const raw = (phoneInput.value||'').trim();
            let sanitized = raw
              .replace(/[\u0660-\u0669]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x0660 + 48))
              .replace(/[\u06F0-\u06F9]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x06F0 + 48))
              .replace(/[^0-9]/g,'')
              .slice(0, 10);
            if(sanitized !== phoneInput.value){ phoneInput.value = sanitized; }
            if(!touched.has('phone')) return;
            const ok = /^05\d{8}$/.test(sanitized);
            if(ok){ hideErr(phoneInput); }
          });
          phoneInput.addEventListener('blur', ()=>{
            touched.add('phone');
            const raw = (phoneInput.value||'').trim();
            let digits = raw
              .replace(/[\u0660-\u0669]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x0660 + 48))
              .replace(/[\u06F0-\u06F9]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x06F0 + 48))
              .replace(/[^0-9]/g,'')
              .slice(0, 10);
            if(digits !== phoneInput.value){ phoneInput.value = digits; }
            const ok = /^05\d{8}$/.test(digits);
            if(ok){ hideErr(phoneInput); }
            else { showErr(phoneInput, 'أدخل رقم جوال صحيح', '10 أرقام تبدأ بـ 05 (مثال: 05XXXXXXXX)'); }
          });
        }
        if(emailInput){
          emailInput.addEventListener('input', ()=>{
            if(!touched.has('email')) return;
            const val = (emailInput.value||'').trim();
            const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
            if(ok){ hideErr(emailInput); }
          });
          emailInput.addEventListener('blur', ()=>{
            touched.add('email');
            const val = (emailInput.value||'').trim();
            const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
            if(ok){ hideErr(emailInput); }
            else { showErr(emailInput, 'أدخل بريدًا إلكترونيًا صالحًا', 'مثال: name@example.com'); }
          });
        }
        if(degreeInput){
          degreeInput.addEventListener('change', ()=>{
            touched.add('degree');
            const ok = !!(degreeInput.value||'').trim();
            if(ok){ hideErr(degreeInput); } else { showErr(degreeInput, 'اختر الدرجة', 'يرجى اختيار الدرجة العلمية'); }
          });
        }
        function renderSkillsChips(){
          if(!skillsChips) return;
          Array.from(skillsChips.querySelectorAll('.chip')).forEach(n=>n.remove());
          skillsTags.forEach((txt, idx)=>{
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.innerHTML = `<span>${txt}</span><button type="button" class="remove" aria-label="حذف ${txt}" data-idx="${idx}"><i class="fa-solid fa-xmark"></i></button>`;
            skillsChips.insertBefore(chip, skillsUI);
            const btn = chip.querySelector('.remove');
            btn.addEventListener('click', ()=>{ skillsTags.splice(idx,1); updateSkillsValue(); renderSkillsChips(); });
          });
        }
        function normalizeTag(v){ return v.replace(/[،,]+/g,' ').replace(/\s+/g,' ').trim(); }
        function updateSkillsValue(){ if(skillsInput) skillsInput.value = skillsTags.join(', '); const ok = (skillsInput.value||'').trim().length>0; if(skillsTouched){ if(ok){ hideErr(skillsInput); } else { showErr(skillsInput, 'أدخل مهاراتك', 'اذكر أبرز مهاراتك باختصار'); } } }
        function addSkillFromValue(v){ const tag = normalizeTag(v); if(!tag) return; if(!skillsTags.includes(tag)){ skillsTags.push(tag); updateSkillsValue(); renderSkillsChips(); } }
        if(skillsUI){
          skillsUI.addEventListener('keydown', (e)=>{
            if(e.key==='Enter' || e.key===',') { e.preventDefault(); addSkillFromValue(skillsUI.value); skillsUI.value=''; }
            else if(e.key==='Backspace' && !skillsUI.value){ skillsTags.pop(); updateSkillsValue(); renderSkillsChips(); }
          });
          skillsUI.addEventListener('blur', ()=>{ addSkillFromValue(skillsUI.value); skillsUI.value=''; skillsTouched = true; updateSkillsValue(); });
          skillsUI.addEventListener('paste', (e)=>{ const text=(e.clipboardData||window.clipboardData).getData('text'); if(text){ e.preventDefault(); text.split(/\n|,|،/).forEach(t=>addSkillFromValue(t)); skillsUI.value=''; } });
          skillsUI.addEventListener('input', ()=>{ if(addSkillBtn){ addSkillBtn.disabled = normalizeTag(skillsUI.value).length===0; } });
        }
        if(addSkillBtn){ addSkillBtn.addEventListener('click', ()=>{ addSkillFromValue(skillsUI.value); skillsUI.value=''; addSkillBtn.disabled = true; skillsUI.focus(); }); addSkillBtn.disabled = true; }
        if(skillsInput){ updateSkillsValue(); renderSkillsChips(); }
        if(preferredCommitteeInput){
          const validatePreferredCommittee = ()=>{
            if(!touched.has('preferredCommittee')) return;
            const ok = (preferredCommitteeInput.value||'').trim().length>0;
            if(ok){ hideErr(preferredCommitteeInput); } else { showErr(preferredCommitteeInput, 'حدد اللجنة المرغوب بها', 'اختر اللجنة التي ترغب بالانضمام إليها'); }
          };
          preferredCommitteeInput.addEventListener('input', ()=>{ if(touched.has('preferredCommittee')){ const ok=(preferredCommitteeInput.value||'').trim().length>0; if(ok) hideErr(preferredCommitteeInput); } });
          preferredCommitteeInput.addEventListener('change', ()=>{ touched.add('preferredCommittee'); validatePreferredCommittee(); });
        }
        if(collegeInput){
          collegeInput.addEventListener('input', ()=>{
            if(!touched.has('college')) return;
            const ok = (collegeInput.value||'').trim().length>0;
            if(ok){ hideErr(collegeInput); }
          });
          collegeInput.addEventListener('blur', ()=>{
            touched.add('college');
            const ok = (collegeInput.value||'').trim().length>0;
            if(ok){ hideErr(collegeInput); } else { showErr(collegeInput, 'أدخل اسم الكلية', 'مثل: كلية الآداب'); }
          });
        }
        if(majorInput){
          majorInput.addEventListener('input', ()=>{
            if(!touched.has('major')) return;
            const ok = (majorInput.value||'').trim().length>0;
            if(ok){ hideErr(majorInput); }
          });
          majorInput.addEventListener('blur', ()=>{
            touched.add('major');
            const ok = (majorInput.value||'').trim().length>0;
            if(ok){ hideErr(majorInput); } else { showErr(majorInput, 'أدخل اسم التخصص', 'مثل: اللغة العربية'); }
          });
        }

        prevBtn.addEventListener('click', ()=>{ showStep(cur-1); });
        nextBtn.addEventListener('click', ()=>{ if(validateStep()) showStep(cur+1); });

        // Prevent Enter from submitting on non-final steps
        form.addEventListener('keydown', (e)=>{
          if(e.key !== 'Enter') return;
          const t = e.target;
          const tag = (t && t.tagName) || '';
          // Allow multiline in textarea and Enter inside skills UI (already handled there)
          if(tag === 'TEXTAREA' || (t && t.id === 'skillsInputUI')) return;
          if(cur < panes.length - 1){
            e.preventDefault();
          }
        });

        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          status.style.display='none'; status.className='alert'; status.textContent='';
          if(!validateStep()) return;
          // Only submit on the last step; otherwise behave like Next
          if(cur < panes.length - 1){
            showStep(cur+1);
            return;
          }
          const s0 = publicSettingsGet();
          if(!isJoinOpenEffective(s0)){
            status.className = 'alert error';
            status.style.display = 'block';
            status.textContent = 'عذرًا، باب التسجيل مغلق حاليًا.';
            return;
          }
          const sb = window.sbClient;
          const payload = {
            full_name: document.getElementById('fullName').value.trim(),
            phone: document.getElementById('phone').value.trim() || null,
            email: document.getElementById('email').value.trim(),
            degree: document.getElementById('degree').value.trim() || null,
            college: document.getElementById('college').value.trim() || null,
            major: document.getElementById('major').value.trim() || null,
            skills: document.getElementById('skills').value.trim() || null,
            preferred_committee: document.getElementById('preferredCommittee').value.trim() || null,
            portfolio_url: document.getElementById('portfolioUrl').value.trim() || null,
            social_twitter: document.getElementById('twitter').value.trim() || null,
            social_instagram: document.getElementById('instagram').value.trim() || null,
            social_linkedin: document.getElementById('linkedin').value.trim() || null,
            about: document.getElementById('about').value.trim(),
            created_at: new Date().toISOString(),
            status: 'new',
            visitor_id: getVisitorId(),
            session_id: getSessionId(),
            path: location.pathname + location.search + location.hash,
            user_agent: (navigator.userAgent||'').slice(0,500)
          };

          const btns = [prevBtn, nextBtn, submitBtn];
          btns.forEach(b=>{ if(b){ b.disabled=true; b.style.opacity=.7; } });

          try{
            let saved = false;
            let remoteFailed = !sb;
            if(sb){
              try{
                const { error } = await sb.from('membership_applications').insert(payload);
                if(error) throw error;
                saved = true;
              } catch(e){ remoteFailed = true; saved = false; }
            }
            if(!saved){
              try{
                const k = 'adeeb_membership_applications';
                const raw = localStorage.getItem(k);
                const arr = raw ? JSON.parse(raw) : [];
                arr.push(payload);
                localStorage.setItem(k, JSON.stringify(arr));
                saved = true;
              } catch(e){ saved = false; }
            }
            if(!saved) throw new Error('تعذر حفظ الطلب. حاول لاحقًا.');

            const wrap = document.querySelector('.card');
            let html = '';
            if(remoteFailed){
              html = `
                <div class="success-wrap">
                  <div style="width:90px;height:90px;margin:0 auto 10px;display:grid;place-items:center;border-radius:50%;background:linear-gradient(135deg,rgba(220,38,38,.12),rgba(220,38,38,.06));box-shadow:0 8px 22px rgba(220,38,38,.2), inset 0 1px 0 rgba(255,255,255,.6);">
                    <i class="fa-solid fa-circle-xmark fa-bounce" style="font-size:48px;color:#dc2626;"></i>
                  </div>
                  <h2 style="margin:10px 0 6px">تعذّر إرسال الطلب</h2>
                  <p class="muted"> تحقق من الاتصال بالإنترنت ثم اضغط «أعد المحاولة».</p>
                  <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
                    <button id="retrySubmitBtn" class="btn btn-primary"><i class="fa-solid fa-rotate-right"></i> أعد المحاولة</button>
                  </div>
                </div>`;
            } else {
              html = `
                <div class="success-wrap">
                  <div style="width:90px;height:90px;margin:0 auto 10px;display:grid;place-items:center;border-radius:50%;background:linear-gradient(135deg,rgba(16,185,129,.12),rgba(16,185,129,.06));box-shadow:0 8px 22px rgba(16,185,129,.2), inset 0 1px 0 rgba(255,255,255,.6);">
                    <i class="fa-solid fa-circle-check fa-bounce" style="font-size:48px;color:#16a34a;"></i>
                  </div>
                  <h2 style="margin:10px 0 6px">تم استلام طلبك بنجاح</h2>
                  <p class="muted">شكرًا لانضمامك إلى نادي أديب. سنراجع طلبك ونتواصل معك قريبًا.</p>
                  <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
                    <a class="btn btn-outline" href="index.html" target="_blank" rel="noopener">
                      <i class="fa-solid fa-globe"></i> تصفح موقع أدِيب
                    </a>
                    <a class="btn btn-outline" href="https://x.com/AB_KFU/status/1978136260439925161" target="_blank" rel="noopener">
                      <i class="fa-solid fa-play"></i> مُشاهدة الفيديو الترويجي
                    </a>
                    <a class="btn btn-primary" href="membership.html">
                      <i class="fa-solid fa-user-plus"></i> تسجيل جديد
                    </a>
                  </div>
                </div>`;
            }
            wrap.innerHTML = html;
            if(remoteFailed){
              const retryBtn = document.getElementById('retrySubmitBtn');
              if(retryBtn){
                retryBtn.addEventListener('click', async ()=>{
                  retryBtn.disabled = true; retryBtn.style.opacity = .7;
                  try{
                    if(!sb) throw new Error('الخدمة غير متاحة الآن');
                    const { error } = await sb.from('membership_applications').insert(payload);
                    if(error) throw error;
                    wrap.innerHTML = `
                      <div class="success-wrap">
                        <div style="width:90px;height:90px;margin:0 auto 10px;display:grid;place-items:center;border-radius:50%;background:linear-gradient(135deg,rgba(16,185,129,.12),rgba(16,185,129,.06));box-shadow:0 8px 22px rgba(16,185,129,.2), inset 0 1px 0 rgba(255,255,255,.6);">
                          <i class="fa-solid fa-circle-check fa-bounce" style="font-size:48px;color:#16a34a;"></i>
                        </div>
                        <h2 style="margin:10px 0 6px">تم إرسال الطلب بنجاح</h2>
                        <p class="muted">شكرًا لانضمامك إلى نادي أديب. سنراجع طلبك ونتواصل معك قريبًا.</p>
                        <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
                          <a class="btn btn-outline" href="index.html" target="_blank" rel="noopener">
                            <i class="fa-solid fa-globe"></i> تصفح موقع أدِيب
                          </a>
                          <a class="btn btn-outline" href="https://www.youtube.com/@ab_kfu" target="_blank" rel="noopener">
                            <i class="fa-solid fa-play"></i> مُشاهدة الفيديو الترويجي
                          </a>
                          <a class="btn btn-primary" href="membership.html">
                            <i class="fa-solid fa-user-plus"></i> تسجيل جديد
                          </a>
                        </div>
                      </div>`;
                  } catch(e){
                    let errBox = wrap.querySelector('.retry-error-box');
                    if(!errBox){
                      errBox = document.createElement('div');
                      errBox.className = 'alert error retry-error-box';
                      errBox.setAttribute('role','alert');
                      errBox.style.display = 'block';
                      errBox.style.margin = '10px auto 0';
                      errBox.style.maxWidth = '540px';
                      errBox.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> <span>لا يزال الإرسال متعذرًا. تحقق من الاتصال وحاول مجددًا.</span>`;
                      const sw = wrap.querySelector('.success-wrap');
                      if(sw) sw.insertBefore(errBox, sw.children[1] || null);
                    } else {
                      errBox.style.display = 'block';
                    }
                  } finally {
                    retryBtn.disabled = false; retryBtn.style.opacity = 1;
                  }
                });
              }
            }
          } catch(err){
            status.className = 'alert error';
            status.textContent = (err && err.message) ? err.message : 'حدث خطأ غير متوقع';
            status.style.display='block';
          } finally {
            btns.forEach(b=>{ if(b){ b.disabled=false; b.style.opacity=1; } });
          }
        });

        function updateCollegeMajorVisibility(){
          const val = ((degreeInput && degreeInput.value) || '').trim();
          const hide = (val === 'ثانوي' || val === 'موظف');
          if(collegeMajorRow) collegeMajorRow.style.display = hide ? 'none' : '';
          if(collegeInput){
            if(hide){ collegeInput.removeAttribute('required'); collegeInput.value=''; }
            else { collegeInput.setAttribute('required',''); }
          }
          if(majorInput){
            if(hide){ majorInput.removeAttribute('required'); majorInput.value=''; }
            else { majorInput.setAttribute('required',''); }
          }
        }
        if(degreeInput){ degreeInput.addEventListener('change', updateCollegeMajorVisibility); }
        updateCollegeMajorVisibility();

        showStep(0);

        // Committee Info Modal
        const committeeInfoBtn = document.getElementById('committeeInfoBtn');
        const committeeModal = document.getElementById('committeeModal');
        const closeModalBtn = document.getElementById('closeModalBtn');

        if(committeeInfoBtn && committeeModal){
          committeeInfoBtn.addEventListener('click', (e)=>{
            e.preventDefault();
            committeeModal.classList.add('active');
          });
        }

        if(closeModalBtn && committeeModal){
          closeModalBtn.addEventListener('click', ()=>{
            committeeModal.classList.remove('active');
          });
        }

        if(committeeModal){
          // Close on backdrop click
          committeeModal.addEventListener('click', (e)=>{
            if(e.target === committeeModal){
              committeeModal.classList.remove('active');
            }
          });

          // Close on ESC key
          document.addEventListener('keydown', (e)=>{
            if(e.key === 'Escape' && committeeModal.classList.contains('active')){
              committeeModal.classList.remove('active');
            }
          });
        }
      })();
    </script>
  </body>
</html>
